#!/usr/bin/env bash
#
# speccyboot-update.py
#
# Simple script to update the 'stage2' second-stage loader,
# used for serving .z80 snapshots over TFTP to SpeccyBoot.
#
# Part of the SpeccyBoot project <http://speccyboot.sourceforge.net>

# if you installed to another directory, you'll have to change this
STAGE2DIR=/usr/local/share/speccyboot

# if your TFTP server serves from another directory than the ones listed here,
# please modify this variable

TFTP_DIRS="/tftpboot /private/tftpboot /srv/tftp /var/lib/tftpboot ${HOME}/tftpboot /var/ftpd /var/tftp"

# -----------------------------------------------------------------------------

for DIR in ${TFTP_DIRS}; do
  SPECCYBOOT=${DIR}/speccyboot
  if [ -d ${SPECCYBOOT} ]; then
    echo Updating SpeccyBoot index in ${SPECCYBOOT}
    cd ${SPECCYBOOT}
    rm -f stage2
    cp ${STAGE2DIR}/spboot.bin stage2
    chmod u+w stage2
    ls -1 *.z80 | sort --ignore-case | tr '\n' '\0' >> stage2
    printf '\0' >> stage2
    chmod a-wx stage2
  fi
done